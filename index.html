<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adams Keegan Payroll Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
        }
        
        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 1.5rem;
        }
        
        .card-header h3 {
            margin: 0;
            font-weight: 600;
        }
        
        .card-body {
            padding: 2rem;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .upload-area:hover::before {
            left: 100%;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            transform: scale(1.02);
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.2) 0%, rgba(40, 167, 69, 0.1) 100%);
            transform: scale(1.05);
        }
        
        .upload-area i {
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .upload-area h4 {
            color: #333;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .upload-area p {
            color: #666;
            margin: 0;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            align-items: center;
        }
        
        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 15px;
            font-weight: bold;
            color: #6c757d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .step.completed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .step-line {
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #e9ecef 0%, #dee2e6 100%);
            margin-top: 24px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .step-line.completed {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }
        
        .hidden {
            display: none !important;
        }
        
        .ssn-textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .ssn-textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .preview-table {
            font-size: 0.9em;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .preview-table th {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 0.8rem 0.5rem;
            vertical-align: middle;
            font-weight: 600;
            border: none;
        }
        
        .preview-table td {
            padding: 0.5rem;
            vertical-align: middle;
            border: 1px solid #e9ecef;
            background: white;
        }
        
        .preview-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .preview-table tbody tr:hover {
            background-color: #e3f2fd;
        }
        
        .preview-table input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 0.3rem;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        
        .preview-table input:focus {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }
        
        .status-message {
            margin-top: 20px;
        }
        
        .btn {
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            border: none;
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, #e55a00 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            border: none;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #138496 0%, #5a32a3 100%);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #343a40 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        }
        
        .btn-delete {
            padding: 0.3rem 0.8rem;
            font-size: 0.8em;
            border-radius: 15px;
        }
        
        .file-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .alert-success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(200, 35, 51, 0.1) 100%);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(253, 126, 20, 0.1) 100%);
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert-info {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.1) 0%, rgba(111, 66, 193, 0.1) 100%);
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        ul {
            padding-left: 1.5rem;
        }
        
        li {
            margin-bottom: 0.5rem;
        }
        
        code {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            color: #667eea;
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: #6c757d !important;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .step {
                width: 40px;
                height: 40px;
                margin: 0 8px;
            }
            
            .step-line {
                width: 40px;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
            
            .card-body {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h1 class="text-center mb-4">Adams Keegan Payroll Converter</h1>
                
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1-indicator">1</div>
                    <div class="step-line"></div>
                    <div class="step" id="step2-indicator">2</div>
                    <div class="step-line"></div>
                    <div class="step" id="step3-indicator">3</div>
                </div>

                <!-- Step 1: File Upload -->
                <div id="step1" class="step-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>Step 1: Upload Payroll Excel File</h3>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                <h4>Drag & Drop Payroll Excel File Here</h4>
                                <p>or click to browse</p>
                                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                            </div>
                            <div id="fileInfo" class="file-info hidden">
                                <strong>File loaded:</strong> <span id="fileName"></span><br>
                                <strong>Rows processed:</strong> <span id="rowCount"></span>
                            </div>
                            <div id="step1-message" class="status-message"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: SSN Management -->
                <div id="step2" class="step-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Step 2: Import SSNs</h3>
                        </div>
                        <div class="card-body">
                            <p>Copy and paste SSN data from Google Sheets. Supports multiple formats:</p>
                            <ul>
                                <li>Tab-separated: <code>Name [tab] SSN</code> or <code>SSN [tab] Name</code></li>
                                <li>Dash-separated: <code>Name - SSN</code></li>
                                <li>Comma-separated: <code>Name, SSN</code></li>
                                <li>Multi-column: <code>SSN [tab] First Name [tab] Middle Name [tab] Last Name</code></li>
                            </ul>
                            <textarea id="ssnTextarea" class="form-control ssn-textarea" 
                                placeholder="Paste SSN data here..."></textarea>
                            <div class="mt-3">
                                <button id="importSsns" class="btn btn-primary">Import SSNs</button>
                                <button id="clearSsns" class="btn btn-warning">Clear All</button>
                                <button id="viewSsns" class="btn btn-info">View Current SSNs</button>
                            </div>
                            <div id="ssnStatus" class="status-message"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Preview & Download -->
                <div id="step3" class="step-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3>Step 3: Preview & Download Adams Keegan Format</h3>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <button id="addEmployee" class="btn btn-success">Add New Employee</button>
                                <button id="downloadExcel" class="btn btn-primary">Download Excel File</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped preview-table" id="previewTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Caregiver</th>
                                            <th>SSN</th>
                                            <th>Total Hours</th>
                                            <th>Reg Hours</th>
                                            <th>OT (1.5x)</th>
                                            <th>DOT (2x)</th>
                                            <th>Miles</th>
                                            <th>Holiday</th>
                                            <th>Hourly (1.5X)</th>
                                            <th>Live In Hours</th>
                                            <th>Live In/Hourly</th>
                                            <th>Per Visit</th>
                                            <th>Holiday Live In/Hourly (1.5X)</th>
                                            <th>No of visit</th>
                                            <th>Base Rate</th>
                                            <th>Method</th>
                                            <th>Expense Reimbursement</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previewTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div id="step3-message" class="status-message"></div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="text-center mt-4">
                    <button id="nextBtn" class="btn btn-primary hidden">Next Step</button>
                    <button id="prevBtn" class="btn btn-secondary hidden">Previous Step</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let wellskyData = [];
        let ssnData = {};
        let convertedData = [];
        let currentStep = 1;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateStepIndicator();
        });

        function initializeEventListeners() {
            // File upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            // SSN management
            document.getElementById('importSsns').addEventListener('click', importSsns);
            document.getElementById('clearSsns').addEventListener('click', clearSsns);
            document.getElementById('viewSsns').addEventListener('click', viewSsns);

            // Navigation
            document.getElementById('nextBtn').addEventListener('click', nextStep);
            document.getElementById('prevBtn').addEventListener('click', prevStep);

            // Step 3 actions
            document.getElementById('addEmployee').addEventListener('click', addNewEmployee);
            document.getElementById('downloadExcel').addEventListener('click', downloadExcel);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showMessage('step1-message', 'Please select a valid Excel file (.xlsx or .xls)', 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    wellskyData = parseWellskyData(jsonData);
                    
                    console.log('Raw Excel data:', jsonData);
                    console.log('Parsed Wellsky data:', wellskyData);
                    
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('rowCount').textContent = wellskyData.length;
                    document.getElementById('fileInfo').classList.remove('hidden');
                    
                    showMessage('step1-message', `Successfully loaded ${wellskyData.length} employee records`, 'success');
                    enableNextStep();
                } catch (error) {
                    showMessage('step1-message', 'Error reading file: ' + error.message, 'danger');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseWellskyData(jsonData) {
            const employees = [];
            let currentEmployee = null;

            console.log('Parsing Wellsky data, total rows:', jsonData.length);

            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                const name = row[0] ? row[0].toString().trim() : '';
                
                console.log(`Row ${i}:`, row, 'Name:', name);
                
                // Check if this is an employee name row (no hours data)
                // Look for rows where only column A has data and other columns are empty or have headers
                if (name && row.length >= 1 && (!row[1] || row[1] === '' || row[1] === 'Total Hours' || row[1] === 'Reg Hours')) {
                    console.log(`  -> Employee name row detected: ${name}`);
                    
                    // Save previous employee if exists
                    if (currentEmployee) {
                        employees.push(currentEmployee);
                        console.log(`  -> Saved previous employee: ${currentEmployee.name} with ${currentEmployee.details.length} details`);
                    }
                    
                    // Start new employee
                    currentEmployee = {
                        name: name,
                        details: []
                    };
                } else if (currentEmployee && row.length >= 9) {
                    // This is a detail row - check if it has numeric data in the right columns
                    const totalHours = parseFloat(row[1]) || 0;
                    const regHours = parseFloat(row[2]) || 0;
                    const ot = parseFloat(row[3]) || 0;
                    const dt = parseFloat(row[4]) || 0;
                    const miles = parseFloat(row[5]) || 0;
                    const baseRate = parseFloat(row[6]) || 0;
                    const method = row[7] ? row[7].toString().trim() : '';
                    const amount = parseFloat(row[8]) || 0;
                    
                    console.log(`  -> Detail row raw data:`, {
                        col0: row[0], col1: row[1], col2: row[2], col3: row[3], col4: row[4], 
                        col5: row[5], col6: row[6], col7: row[7], col8: row[8]
                    });
                    
                    // Check specifically for mileage rows
                    if (miles > 0) {
                        console.log(`  -> MILEAGE DETECTED: ${miles} miles in method: "${method}"`);
                    }
                    
                    // Only add if there's actual data (not just zeros) OR if it's a mileage-only row
                    if (totalHours > 0 || regHours > 0 || ot > 0 || dt > 0 || miles > 0 || baseRate > 0 || amount > 0) {
                        const detail = {
                            totalHours: totalHours,
                            regHours: regHours,
                            ot: ot,
                            dt: dt,
                            miles: miles,
                            baseRate: baseRate,
                            method: method,
                            amount: amount
                        };
                        currentEmployee.details.push(detail);
                        console.log(`  -> Added detail row:`, detail);
                    } else {
                        console.log(`  -> Skipped row (all zeros):`, row);
                    }
                }
            }

            // Add the last employee
            if (currentEmployee) {
                employees.push(currentEmployee);
                console.log(`Final employee saved: ${currentEmployee.name} with ${currentEmployee.details.length} details`);
            }

            console.log('Final parsed employees:', employees);
            return employees;
        }

        function importSsns() {
            const textarea = document.getElementById('ssnTextarea');
            const text = textarea.value.trim();
            
            if (!text) {
                showMessage('ssnStatus', 'Please enter SSN data', 'warning');
                return;
            }

            const lines = text.split('\n');
            let newCount = 0;
            let updatedCount = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                let name, ssn;
                
                // Handle tab-separated data (most common from Google Sheets)
                if (line.includes('\t')) {
                    const parts = line.split('\t');
                    if (parts.length >= 2) {
                        // Check if first part looks like SSN (contains dashes or is all digits)
                        const firstPart = parts[0].trim();
                        const secondPart = parts[1].trim();
                        
                        if (firstPart.match(/^\d{3}-?\d{2}-?\d{4}$/) || firstPart.match(/^\d{9}$/)) {
                            // First column is SSN, rest is name
                            ssn = firstPart.replace(/\D/g, '');
                            name = parts.slice(1).join(' ').trim();
                        } else {
                            // First column is name, second is SSN
                            name = firstPart;
                            ssn = secondPart.replace(/\D/g, '');
                        }
                    }
                } else if (line.includes(' - ')) {
                    [name, ssn] = line.split(' - ');
                } else if (line.includes(',')) {
                    [name, ssn] = line.split(',');
                } else {
                    return; // Skip invalid lines
                }

                name = name.trim();
                ssn = ssn.trim().replace(/\D/g, ''); // Remove non-digits

                if (name && ssn && ssn.length === 9) {
                    // Normalize name for consistent matching (store both original and normalized)
                    const normalizedName = name.toLowerCase().trim().replace(/\s+/g, ' ');
                    
                    // Store with normalized name as key for better matching
                    // But also store original name mapping for display
                    if (ssnData[normalizedName]) {
                        updatedCount++;
                    } else {
                        newCount++;
                    }
                    ssnData[normalizedName] = ssn;
                    // Also store original name mapping for display/fallback
                    if (normalizedName !== name) {
                        ssnData[name] = ssn;
                    }
                }
            });

            const totalSsns = Object.keys(ssnData).length;
            showMessage('ssnStatus', 
                `${totalSsns} SSNs loaded (${newCount} new, ${updatedCount} updated)`, 
                'success');
            
            textarea.value = '';
            enableNextStep();
        }

        function clearSsns() {
            ssnData = {};
            showMessage('ssnStatus', 'All SSNs cleared', 'info');
        }

        function viewSsns() {
            const ssnList = Object.entries(ssnData)
                .map(([name, ssn]) => `${name}: ${ssn}`)
                .join('\n');
            
            if (ssnList) {
                alert('Current SSNs:\n\n' + ssnList);
            } else {
                alert('No SSNs loaded');
            }
        }

        function findSsnByName(name) {
            if (!name) return '';
            
            // Normalize the name for matching
            const normalize = (str) => {
                return str.toLowerCase().trim().replace(/\s+/g, ' ');
            };
            
            const normalizedName = normalize(name);
            
            // Try exact match first (case-insensitive)
            for (const [ssnName, ssn] of Object.entries(ssnData)) {
                if (normalize(ssnName) === normalizedName) {
                    console.log(`Exact match found: "${name}" -> "${ssnName}" -> SSN: ${ssn}`);
                    return ssn;
                }
            }
            
            // Try partial match (contains or is contained)
            for (const [ssnName, ssn] of Object.entries(ssnData)) {
                const normalizedSsnName = normalize(ssnName);
                if (normalizedName.includes(normalizedSsnName) || normalizedSsnName.includes(normalizedName)) {
                    console.log(`Partial match found: "${name}" -> "${ssnName}" -> SSN: ${ssn}`);
                    return ssn;
                }
            }
            
            // Try matching by last name (for cases like "Last, First" vs "First Last")
            const nameParts = normalizedName.split(/[,\s]+/).filter(p => p.length > 0);
            if (nameParts.length >= 2) {
                for (const [ssnName, ssn] of Object.entries(ssnData)) {
                    const ssnNameParts = normalize(ssnName).split(/[,\s]+/).filter(p => p.length > 0);
                    // Check if last names match
                    const lastName1 = nameParts[nameParts.length - 1];
                    const lastName2 = ssnNameParts[ssnNameParts.length - 1];
                    if (lastName1 === lastName2 && lastName1.length > 2) {
                        console.log(`Last name match found: "${name}" -> "${ssnName}" -> SSN: ${ssn}`);
                        return ssn;
                    }
                }
            }
            
            console.log(`No SSN match found for: "${name}"`);
            return '';
        }

        function convertToAdamsKeegan() {
            convertedData = [];
            console.log('Starting conversion with', wellskyData.length, 'employees');
            console.log('Available SSN data:', ssnData);

            wellskyData.forEach((employee, empIndex) => {
                console.log(`Processing employee ${empIndex + 1}:`, employee);
                
                const employeeName = employee.name;
                const ssn = findSsnByName(employeeName);
                console.log(`Employee: ${employeeName}, SSN: ${ssn}, Details:`, employee.details);

                // Group details by base rate
                const rateGroups = {};
                let miles = 0;
                let expenseReimbursement = 0;

                employee.details.forEach((detail, detailIndex) => {
                    console.log(`  Detail ${detailIndex + 1}:`, detail);
                    
                    // Collect miles and expenses for first row
                    if (detail.method && detail.method.toLowerCase() === 'per mile') {
                        miles += detail.miles;
                        console.log(`    Added miles: ${detail.miles}`);
                    }
                    if (detail.method && detail.method.toLowerCase() === 'not payable') {
                        expenseReimbursement += detail.amount;
                        console.log(`    Added expense: ${detail.amount}`);
                    }

                    // Group by base rate
                    const rate = detail.baseRate;
                    if (!rateGroups[rate]) {
                        rateGroups[rate] = {
                            totalHours: 0,
                            regHours: 0,
                            ot: 0,
                            dt: 0,
                            baseRate: rate,
                            method: detail.method
                        };
                        console.log(`    Created new rate group for rate: ${rate}`);
                    }

                    rateGroups[rate].totalHours += detail.totalHours;
                    rateGroups[rate].regHours += detail.regHours;
                    rateGroups[rate].ot += detail.ot;
                    rateGroups[rate].dt += detail.dt;
                    console.log(`    Updated rate group ${rate}:`, rateGroups[rate]);
                });

                console.log(`  Final rate groups:`, rateGroups);
                console.log(`  Miles: ${miles}, Expenses: ${expenseReimbursement}`);

                // Create rows for each rate group
                const rates = Object.keys(rateGroups).sort((a, b) => parseFloat(a) - parseFloat(b));
                console.log(`  Rates to process:`, rates);
                
                rates.forEach((rate, index) => {
                    const group = rateGroups[rate];
                    const row = {
                        caregiver: employeeName,
                        ssn: ssn,
                        totalHours: group.totalHours,
                        regHours: group.regHours,
                        ot: group.ot,
                        dt: group.dt,
                        miles: index === 0 ? miles : 0, // Only on first row
                        holiday: 0,
                        hourly15x: 0,
                        liveInHours: 0,
                        liveInHourly: 0,
                        perVisit: 0,
                        holidayLiveInHourly15x: 0,
                        noOfVisit: 0,
                        baseRate: group.baseRate,
                        method: group.method,
                        expenseReimbursement: index === 0 ? expenseReimbursement : 0 // Only on first row
                    };
                    console.log(`    Created row for rate ${rate}:`, row);
                    convertedData.push(row);
                });

                // If employee has only miles/expenses (no hours), create a row with zeros
                if (rates.length === 0 && (miles > 0 || expenseReimbursement > 0)) {
                    const row = {
                        caregiver: employeeName,
                        ssn: ssn,
                        totalHours: 0,
                        regHours: 0,
                        ot: 0,
                        dt: 0,
                        miles: miles,
                        holiday: 0,
                        hourly15x: 0,
                        liveInHours: 0,
                        liveInHourly: 0,
                        perVisit: 0,
                        holidayLiveInHourly15x: 0,
                        noOfVisit: 0,
                        baseRate: 0,
                        method: '',
                        expenseReimbursement: expenseReimbursement
                    };
                    console.log(`    Created zero-hours row:`, row);
                    convertedData.push(row);
                }
            });
            
            console.log('Final converted data:', convertedData);
        }

        function renderPreviewTable() {
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';

            if (convertedData.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="18" class="text-center text-muted">No employee data found. Please check your Wellsky file format.</td>';
                tbody.appendChild(tr);
                return;
            }

            convertedData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${row.caregiver}" data-field="caregiver" data-index="${index}"></td>
                    <td><input type="text" value="${row.ssn}" data-field="ssn" data-index="${index}" maxlength="9"></td>
                    <td><input type="number" value="${row.totalHours}" data-field="totalHours" data-index="${index}" step="0.01"></td>
                    <td><input type="number" value="${row.regHours}" data-field="regHours" data-index="${index}" step="0.01"></td>
                    <td><input type="number" value="${row.ot}" data-field="ot" data-index="${index}" step="0.01"></td>
                    <td><input type="number" value="${row.dt}" data-field="dt" data-index="${index}" step="0.01"></td>
                    <td><input type="number" value="${row.miles}" data-field="miles" data-index="${index}" step="0.01"></td>
                    <td><input type="number" value="${row.holiday}" data-field="holiday" data-index="${index}" step="0.01" readonly></td>
                    <td><input type="number" value="${row.hourly15x}" data-field="hourly15x" data-index="${index}" step="0.01" readonly></td>
                    <td><input type="number" value="${row.liveInHours}" data-field="liveInHours" data-index="${index}" step="0.01" readonly></td>
                    <td><input type="number" value="${row.liveInHourly}" data-field="liveInHourly" data-index="${index}" step="0.01" readonly></td>
                    <td><input type="number" value="${row.perVisit}" data-field="perVisit" data-index="${index}" step="0.01" readonly></td>
                    <td><input type="number" value="${row.holidayLiveInHourly15x}" data-field="holidayLiveInHourly15x" data-index="${index}" step="0.01" readonly></td>
                    <td><input type="number" value="${row.noOfVisit}" data-field="noOfVisit" data-index="${index}" step="0.01" readonly></td>
                    <td><input type="number" value="${row.baseRate}" data-field="baseRate" data-index="${index}" step="0.01"></td>
                    <td><input type="text" value="${row.method}" data-field="method" data-index="${index}"></td>
                    <td><input type="number" value="${row.expenseReimbursement}" data-field="expenseReimbursement" data-index="${index}" step="0.01"></td>
                    <td><button class="btn btn-danger btn-sm btn-delete" onclick="deleteRow(${index})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });

            // Add event listeners for input changes
            tbody.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', updateDataFromInput);
            });
        }

        function updateDataFromInput(e) {
            const field = e.target.dataset.field;
            const index = parseInt(e.target.dataset.index);
            const value = e.target.value;

            if (field === 'ssn') {
                // Format SSN input
                const digits = value.replace(/\D/g, '');
                if (digits.length <= 9) {
                    convertedData[index][field] = digits;
                    e.target.value = digits;
                }
            } else if (field === 'totalHours' || field === 'regHours' || field === 'ot' || field === 'dt' || 
                      field === 'miles' || field === 'baseRate' || field === 'expenseReimbursement') {
                convertedData[index][field] = parseFloat(value) || 0;
            } else {
                convertedData[index][field] = value;
            }
        }

        function deleteRow(index) {
            convertedData.splice(index, 1);
            renderPreviewTable();
        }

        function addNewEmployee() {
            const newEmployee = {
                caregiver: '',
                ssn: '',
                totalHours: 0,
                regHours: 0,
                ot: 0,
                dt: 0,
                miles: 0,
                holiday: 0,
                hourly15x: 0,
                liveInHours: 0,
                liveInHourly: 0,
                perVisit: 0,
                holidayLiveInHourly15x: 0,
                noOfVisit: 0,
                baseRate: 0,
                method: '',
                expenseReimbursement: 0
            };
            convertedData.push(newEmployee);
            renderPreviewTable();
        }

        function downloadExcel() {
            if (convertedData.length === 0) {
                showMessage('step3-message', 'No data to download', 'warning');
                return;
            }

            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Convert data to worksheet format
            const wsData = [
                ['Caregiver', 'SSN', 'Total Hours', 'Reg Hours', 'OT (1.5x)', 'DOT (2x)', 'Miles', 
                 'Holiday', 'Hourly (1.5X)', 'Live In Hours', 'Live In/Hourly', 'Per Visit', 
                 'Holiday Live In/Hourly (1.5X)', 'No of visit', 'Base Rate', 'Method', 'Expense reimbursement']
            ];

            convertedData.forEach(row => {
                wsData.push([
                    row.caregiver,
                    row.ssn,
                    row.totalHours,
                    row.regHours,
                    row.ot,
                    row.dt,
                    row.miles,
                    row.holiday,
                    row.hourly15x,
                    row.liveInHours,
                    row.liveInHourly,
                    row.perVisit,
                    row.holidayLiveInHourly15x,
                    row.noOfVisit,
                    row.baseRate,
                    row.method,
                    row.expenseReimbursement
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Adams Keegan Format');
            
            // Generate filename with current date
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;
            const filename = `Adams_Keegan_Payroll_${dateString}.xlsx`;
            
            // Download file
            XLSX.writeFile(wb, filename);
            showMessage('step3-message', `Excel file downloaded successfully as ${filename}!`, 'success');
        }

        function nextStep() {
            if (currentStep < 3) {
                currentStep++;
                
                if (currentStep === 3) {
                    console.log('Converting to Adams Keegan...');
                    console.log('Wellsky data:', wellskyData);
                    console.log('SSN data:', ssnData);
                    
                    convertToAdamsKeegan();
                    console.log('Converted data:', convertedData);
                    
                    renderPreviewTable();
                }
                
                updateStepIndicator();
                updateStepVisibility();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepIndicator();
                updateStepVisibility();
            }
        }

        function updateStepIndicator() {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                indicator.classList.remove('active', 'completed');
                
                if (i < currentStep) {
                    indicator.classList.add('completed');
                } else if (i === currentStep) {
                    indicator.classList.add('active');
                }
            }

            // Update step lines
            for (let i = 1; i <= 2; i++) {
                const line = document.querySelector(`.step-line:nth-child(${i * 2})`);
                if (i < currentStep) {
                    line.classList.add('completed');
                } else {
                    line.classList.remove('completed');
                }
            }
        }

        function updateStepVisibility() {
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                if (i === currentStep) {
                    step.classList.remove('hidden');
                } else {
                    step.classList.add('hidden');
                }
            }

            // Update navigation buttons
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            
            if (currentStep === 1) {
                nextBtn.classList.remove('hidden');
                prevBtn.classList.add('hidden');
            } else if (currentStep === 3) {
                nextBtn.classList.add('hidden');
                prevBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                prevBtn.classList.remove('hidden');
            }
        }

        function enableNextStep() {
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.classList.remove('hidden');
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 3000);
            }
        }
    </script>
</body>
</html>
